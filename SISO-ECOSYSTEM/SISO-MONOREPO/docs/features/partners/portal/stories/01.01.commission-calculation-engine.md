# Story 1.1: Commission Calculation Engine - Brownfield Addition

## User Story

As a **SISO Partner**,
I want **real-time commission calculation and tracking for all my referrals**,
So that **I can see my earnings immediately and trust the payment process**.

## Story Context

**Existing System Integration:**

- Integrates with: Existing Partnership Dashboard (`PartnerDashboard.tsx`), Commission Types (`partnership.ts`), Partner Stats Hook (`usePartnerStats.ts`)
- Technology: React + TypeScript + Supabase + Stripe Connect
- Follows pattern: Existing hooks pattern with loading states and error handling
- Touch points: Dashboard stats cards, commission display components, payment processing

## Acceptance Criteria

**Functional Requirements:**

1. Commission amounts are calculated in real-time based on partner tier and referral value
2. Commission status progression: pending → approved → paid with automated transitions
3. Partners can view detailed commission breakdown by referral in dashboard
4. Commission rates vary by partner tier (Bronze: 10%, Silver: 12%, Gold: 15%, Platinum: 20%)
5. System handles commission disputes and adjustments through admin interface

**Integration Requirements:**
6. Existing `PartnerDashboard.tsx` displays accurate commission data without breaking current layout
7. New commission calculations integrate with existing `usePartnerStats.ts` hook pattern
8. Integration with `partnership.ts` types maintains current type safety standards
9. Commission payment integration follows existing Stripe Connect architecture

**Quality Requirements:**
10. Commission calculations are covered by comprehensive unit and integration tests
11. Real-time updates work without page refresh using existing WebSocket patterns
12. No regression in existing partnership dashboard functionality verified through automated testing

## Technical Notes

- **Integration Approach**: Extend existing `usePartnerStats.ts` hook with commission calculation functions, integrate with Supabase commission tables
- **Existing Pattern Reference**: Follow `usePartnerApplication.ts` pattern for API calls with loading states, error handling, and toast notifications
- **Key Constraints**: Must maintain existing dashboard performance (<2s load time), preserve mobile responsiveness, ensure commission data security with partner data isolation

## Dev Notes

### Existing System Integration Context:

**Relevant Source Tree Information:**
- `src/components/dashboard/PartnerDashboard.tsx` - Main dashboard with commission display area (lines 180-200 stats cards)
- `src/hooks/usePartnerStats.ts` - Statistics hook with TODO for partner dashboard data fetching (lines 45-70)
- `src/types/partnership.ts` - Complete commission types already defined (Commission, CommissionInsert, CommissionUpdate)
- `src/migrations/partnership_tier_system.sql` - Database schema with commission rates by tier
- `src/api/partnership.ts` - API structure exists, needs commission calculation endpoints

**Integration Points:**
1. **Dashboard Display**: Commission cards in dashboard grid layout (row-3-cards section)
2. **Stats Hook**: Extend `usePartnerStats.ts` with commission-specific data fetching
3. **Database**: Use existing `commissions` table schema with calculated fields
4. **API Layer**: Add commission calculation endpoints to existing partnership API structure
5. **Real-time Updates**: Integrate with existing WebSocket pattern for live commission updates

**Implementation Context:**
The dashboard already displays mock commission data (£2,450 total, £1,500 monthly). This story will replace mock data with real calculated commissions from the database using the existing UI components and patterns.

### Testing Standards

**Testing Requirements:**
- **Test File Location**: `src/hooks/__tests__/usePartnerStats.test.ts`, `src/api/__tests__/partnership.test.ts`
- **Test Standards**: Jest + React Testing Library for hooks, Supertest for API endpoints
- **Testing Frameworks**: Follow existing test patterns in `usePartnerApplication.test.ts`
- **Specific Testing Requirements**: 
  - Commission calculation accuracy for all tier levels
  - Real-time update functionality with WebSocket mocks
  - Error handling for payment processing failures
  - Mobile responsive display testing

## Definition of Done

- [ ] Commission calculation engine processes referrals based on partner tier rates
- [ ] Real-time commission tracking updates dashboard without page refresh  
- [ ] Integration with existing dashboard preserves all current functionality
- [ ] Commission payment processing integrates with Stripe Connect
- [ ] Code follows existing TypeScript patterns and partnership type definitions
- [ ] Tests pass for commission calculations, API endpoints, and dashboard integration
- [ ] Mobile-responsive commission display works on all device sizes
- [ ] Partner data isolation maintained for commission security
- [ ] Documentation updated for new commission calculation API endpoints

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-13 | 1.0 | Initial story creation for commission calculation engine | Claude |

## Dev Agent Record

### Agent Model Used
- **Model**: Claude-3.5-Sonnet (Opus 4.1)
- **Version**: 2025-01-13

### Debug Log References
- Partnership portal feature analysis: `docs-bmad/partnership-portal-feature-analysis.md`
- Existing commission types: `src/types/partnership.ts` (lines 15-20, 80-100)
- Dashboard integration points: `src/components/dashboard/PartnerDashboard.tsx`

### Completion Notes List
- Story follows BMAD brownfield template for existing system integration
- Commission calculation logic will extend existing partnership dashboard
- Real-time updates will use existing WebSocket infrastructure
- Payment processing will integrate with current Stripe Connect setup

### File List
**Files to be created:**
- `src/api/partnerships/commissions.ts` - Commission calculation API endpoints
- `src/hooks/useCommissionTracking.ts` - Commission-specific hook for real-time tracking
- `src/components/partnership/CommissionDetailModal.tsx` - Detailed commission breakdown modal
- `src/utils/commissionCalculator.ts` - Commission calculation utility functions

**Files to be modified:**
- `src/hooks/usePartnerStats.ts` - Add commission data fetching
- `src/components/dashboard/PartnerDashboard.tsx` - Connect real commission data
- `src/types/partnership.ts` - Add commission calculation result types
- `src/api/partnership.ts` - Add commission endpoints to main API structure

## QA Results

*To be completed by QA Agent after implementation*